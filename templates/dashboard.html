{% extends "base.html" %}

{% block title %}Medical Dashboard - Fetal Brain AI{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
    <!-- Dashboard Header -->
    <section class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="dashboard-title">
                        <h1><i class="fas fa-tachometer-alt"></i> Medical Dashboard</h1>
                        <p class="dashboard-subtitle">
                            Welcome back, <strong>{{ username }}</strong>. Ready to analyze fetal brain scans?
                        </p>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <div class="dashboard-stats">
                        <div class="stat-item">
                            <span class="stat-number">{{ recent_analyses|length }}</span>
                            <span class="stat-label">Recent Scans</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="container-fluid">
        <div class="row">
            <!-- Main Analysis Panel -->
            <div class="col-lg-8">
                <!-- Upload Section -->
                <div class="analysis-panel">
                    <div class="panel-header">
                        <h3><i class="fas fa-upload"></i> Upload & Analyze Brain Scan</h3>
                        <p>Drag and drop your fetal brain scan image or click to browse</p>
                    </div>
                    
                    <!-- Drag & Drop Upload Area -->
                    <div class="upload-container" id="uploadContainer">
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-content">
                                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                <h4>Drag & Drop Brain Scan</h4>
                                <p>or <button type="button" class="btn btn-outline-primary" id="browseBtn">Browse Files</button></p>
                                <small class="text-muted">Supported: JPG, PNG, GIF, BMP (Max: 16MB)</small>
                                <input type="file" id="fileInput" accept="image/*" style="display: none;">
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="upload-progress" id="uploadProgress" style="display: none;">
                                <div class="progress mb-3">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" id="progressBar"></div>
                                </div>
                                <p class="upload-status" id="uploadStatus">Uploading...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Image Preview -->
                    <div class="image-preview-container" id="imagePreview" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="preview-card">
                                    <h5><i class="fas fa-image"></i> Original Scan</h5>
                                    <img id="originalImage" class="preview-image" alt="Original scan">
                                    <div class="image-info" id="imageInfo"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="preview-card">
                                    <h5><i class="fas fa-brain"></i> Detected Abnormality</h5>
                                    <div class="result-placeholder" id="resultPlaceholder">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        <p>Analyzing brain scan...</p>
                                    </div>
                                    <img id="resultImage" class="preview-image" alt="Analysis result" style="display: none;">
                                    <div class="detection-info" id="detectionInfo" style="display: none;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Download Report Button -->
                <div class="text-center mt-4" id="downloadSection" style="display: none;">
                    <button class="btn btn-primary btn-lg" id="downloadReportBtn">
                        <i class="fas fa-download"></i> Download Full Report (PDF)
                    </button>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Quick Stats -->
                <div class="sidebar-card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie"></i> Quick Stats</h5>
                    </div>
                    <div class="card-body">
                        <div class="stat-row">
                            <span class="stat-label">Total Analyses</span>
                            <span class="stat-badge">{{ recent_analyses|length }}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Model Accuracy</span>
                            <span class="stat-badge success">95.5%</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Supported Classes</span>
                            <span class="stat-badge info">14</span>
                        </div>
                    </div>
                </div>

                <!-- Recent Analyses -->
                <div class="sidebar-card">
                    <div class="card-header">
                        <h5><i class="fas fa-history"></i> Recent Analyses</h5>
                        <a href="{{ url_for('history') }}" class="btn btn-sm btn-outline-primary">View All</a>
                    </div>
                    <div class="card-body">
                        {% if recent_analyses %}
                            {% for analysis in recent_analyses %}
                            <div class="recent-item">
                                <div class="recent-icon">
                                    <i class="fas fa-file-medical"></i>
                                </div>
                                <div class="recent-content">
                                    <h6>{{ analysis[0][:20] }}{% if analysis[0]|length > 20 %}...{% endif %}</h6>
                                    <p class="recent-result">{{ analysis[1] }}</p>
                                    <small class="recent-time">
                                        <i class="fas fa-clock"></i> {{ analysis[3] }}
                                    </small>
                                </div>
                                <div class="recent-confidence">
                                    <span class="confidence-badge">{{ "%.1f"|format(analysis[2] * 100) }}%</span>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center text-muted">
                                <i class="fas fa-inbox fa-2x mb-3"></i>
                                <p>No recent analyses yet.<br>Upload your first scan above!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Medical Guidelines -->
                <div class="sidebar-card">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle"></i> Guidelines</h5>
                    </div>
                    <div class="card-body">
                        <div class="guideline-item">
                            <i class="fas fa-check-circle text-success"></i>
                            <span>Use high-quality ultrasound/MRI images</span>
                        </div>
                        <div class="guideline-item">
                            <i class="fas fa-check-circle text-success"></i>
                            <span>Ensure proper contrast and clarity</span>
                        </div>
                        <div class="guideline-item">
                            <i class="fas fa-exclamation-triangle text-warning"></i>
                            <span>Always consult medical professionals</span>
                        </div>
                        <div class="guideline-item">
                            <i class="fas fa-shield-alt text-info"></i>
                            <span>Results are for research purposes</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Dashboard functionality
    class MedicalDashboard {
        constructor() {
            this.currentFilename = null;
            this.initializeUpload();
            this.bindEvents();
        }

        initializeUpload() {
            this.uploadArea = document.getElementById('uploadArea');
            this.fileInput = document.getElementById('fileInput');
            this.browseBtn = document.getElementById('browseBtn');
            
            // Drag and drop events
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                this.uploadArea.addEventListener(eventName, this.preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                this.uploadArea.addEventListener(eventName, () => this.highlight(), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                this.uploadArea.addEventListener(eventName, () => this.unhighlight(), false);
            });

            this.uploadArea.addEventListener('drop', (e) => this.handleDrop(e), false);
            this.browseBtn.addEventListener('click', () => this.fileInput.click());
            this.fileInput.addEventListener('change', (e) => this.handleFiles(e.target.files));
        }

        bindEvents() {
            // Download report button
            const downloadBtn = document.getElementById('downloadReportBtn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', () => this.downloadReport());
            }
        }

        preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        highlight() {
            this.uploadArea.classList.add('drag-over');
        }

        unhighlight() {
            this.uploadArea.classList.remove('drag-over');
        }

        handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            this.handleFiles(files);
        }

        handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                if (this.validateFile(file)) {
                    this.uploadFile(file);
                }
            }
        }

        validateFile(file) {
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp'];
            const maxSize = 16 * 1024 * 1024; // 16MB

            if (!validTypes.includes(file.type)) {
                this.showAlert('Invalid file type. Please upload an image file.', 'error');
                return false;
            }

            if (file.size > maxSize) {
                this.showAlert('File too large. Maximum size is 16MB.', 'error');
                return false;
            }

            return true;
        }

        uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            // Show progress
            this.showProgress();
            
            // Preview image immediately
            this.previewImage(file);

            // Start analysis timer
            const startTime = Date.now();

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const endTime = Date.now();
                const analysisTime = ((endTime - startTime) / 1000).toFixed(1);
                
                if (data.success) {
                    this.currentFilename = data.results.filename;
                    this.showResults(data.results, analysisTime);
                } else {
                    this.showAlert(data.error || 'Upload failed', 'error');
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                this.showAlert('Upload failed. Please try again.', 'error');
            })
            .finally(() => {
                this.hideProgress();
            });
        }

        previewImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const originalImage = document.getElementById('originalImage');
                originalImage.src = e.target.result;
                
                // Show image info
                const imageInfo = document.getElementById('imageInfo');
                imageInfo.innerHTML = `
                    <small class="text-muted">
                        <i class="fas fa-file"></i> ${file.name}<br>
                        <i class="fas fa-weight"></i> ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                        <i class="fas fa-calendar"></i> ${new Date().toLocaleString()}
                    </small>
                `;
                
                document.getElementById('imagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        showProgress() {
            document.getElementById('uploadProgress').style.display = 'block';
            const progressBar = document.getElementById('progressBar');
            let progress = 0;
            
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                
                progressBar.style.width = progress + '%';
                progressBar.setAttribute('aria-valuenow', progress);
                
                if (progress >= 90) clearInterval(interval);
            }, 200);
        }

        hideProgress() {
            document.getElementById('uploadProgress').style.display = 'none';
        }

        showResults(results, analysisTime) {
            // Show result image if available
            if (results.has_result_image && results.result_image_url) {
                const resultImage = document.getElementById('resultImage');
                resultImage.src = results.result_image_url;
                resultImage.style.display = 'block';
                document.getElementById('resultPlaceholder').style.display = 'none';
                
                // Show detection info
                const detectionInfo = document.getElementById('detectionInfo');
                if (results.detected_abnormality) {
                    detectionInfo.innerHTML = `
                        <small class="text-success mt-2">
                            <i class="fas fa-check-circle"></i> <strong>Detected:</strong> ${results.detected_abnormality}<br>
                            <i class="fas fa-clock"></i> Analysis Time: ${analysisTime}s
                        </small>
                    `;
                    detectionInfo.style.display = 'block';
                    
                    // Show download button
                    document.getElementById('downloadSection').style.display = 'block';
                } else {
                    detectionInfo.innerHTML = `
                        <small class="text-muted mt-2">
                            <i class="fas fa-info-circle"></i> No abnormalities detected<br>
                            <i class="fas fa-clock"></i> Analysis Time: ${analysisTime}s
                        </small>
                    `;
                    detectionInfo.style.display = 'block';
                }
            } else {
                // No result image, just show placeholder with message
                const resultPlaceholder = document.getElementById('resultPlaceholder');
                resultPlaceholder.innerHTML = `
                    <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
                    <p>Analysis Complete</p>
                    <small class="text-muted">No abnormalities detected</small>
                `;
            }
        }

        downloadReport() {
            if (this.currentFilename) {
                window.location.href = `/download_report/${this.currentFilename}`;
            }
        }

        showAlert(message, type) {
            // Create alert element
            const alert = document.createElement('div');
            alert.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insert at top of dashboard
            const dashboard = document.querySelector('.dashboard-wrapper');
            dashboard.insertBefore(alert, dashboard.firstChild);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
    }

    // Initialize dashboard when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        new MedicalDashboard();
    });
</script>
{% endblock %}
